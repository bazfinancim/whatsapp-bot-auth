<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>צ'אט בוט פיננסי - אבי ישי</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/framer-motion@10/dist/framer-motion.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0d0d0d;
            color: white;
            min-height: 100vh;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 100%;
            margin: 0 auto;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .messages-inner {
            max-width: 1024px;
            margin: 0 auto;
        }

        .message-wrapper {
            margin-bottom: 1.5rem;
            opacity: 0;
            animation: fadeInUp 0.3s ease-out forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-container {
            display: flex;
        }

        .message-container.user {
            justify-content: flex-end;
        }

        .message-container.bot {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 80%;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .message-bubble:hover {
            transform: translateY(-2px);
        }

        .message-bubble.bot {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border: 1px solid rgba(40, 199, 111, 0.3);
        }

        .message-bubble.bot:hover {
            border-color: rgba(40, 199, 111, 0.5);
            box-shadow: 0 10px 25px rgba(40, 199, 111, 0.2);
        }

        .message-bubble.user {
            background: linear-gradient(135deg, #28c76f 0%, #22a05e 100%);
            color: black;
            border: 1px solid #28c76f;
            margin-left: auto;
        }

        .message-bubble.user:hover {
            box-shadow: 0 10px 25px rgba(40, 199, 111, 0.4);
        }

        .message-text {
            white-space: pre-wrap;
            text-align: right;
            line-height: 1.6;
        }

        .message-text strong {
            font-weight: bold;
            color: #FFD700;
        }

        .message-image {
            margin-top: 1rem;
            display: flex;
            justify-content: center;
        }

        .message-image img {
            max-width: 800px;
            width: 100%;
            height: auto;
            border-radius: 8px;
            border: 1px solid rgba(40, 199, 111, 0.3);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        .message-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding: 0 1rem;
        }

        .chat-button {
            background: #FFD700;
            color: black;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            font-size: 0.95rem;
        }

        .chat-button:hover:not(:disabled) {
            background: #FFC700;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            transform: scale(1.02);
        }

        .chat-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-button.special {
            background: #28c76f;
            border-color: rgba(40, 199, 111, 0.3);
        }

        .chat-button.special:hover:not(:disabled) {
            background: #22a05e;
        }

        .message-input-form {
            margin-top: 1.5rem;
            animation: fadeInUp 0.3s ease-out 0.2s backwards;
        }

        .input-group {
            display: flex;
            gap: 0.75rem;
        }

        .chat-input {
            flex: 1;
            padding: 1rem;
            border: 1px solid rgba(40, 199, 111, 0.3);
            border-radius: 12px;
            background: #1a1a1a;
            color: white;
            font-size: 1rem;
            text-align: right;
            transition: all 0.3s ease;
        }

        .chat-input::placeholder {
            color: #666;
        }

        .chat-input:focus {
            outline: none;
            border-color: #28c76f;
            box-shadow: 0 0 0 3px rgba(40, 199, 111, 0.2);
        }

        .submit-button {
            background: #FFD700;
            color: black;
            font-weight: bold;
            padding: 1rem 2rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .submit-button:hover {
            background: #FFC700;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
            transform: scale(1.02);
        }

        .back-button {
            position: fixed;
            top: 1rem;
            left: 1rem;
            background: #FFD700;
            color: black;
            font-weight: bold;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            text-decoration: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            z-index: 50;
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: #FFC700;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Use our own API endpoint instead of calling Make.com directly
        const WEBHOOK_URL = '/api/submit-form';

        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const phoneRegex = /^05\d{8}$/;

        const chatSteps = [
            {
                id: 1,
                message: '',
                gif: '/images/chatbot/intro-v4.png?v=20251120v4',
                buttons: ['מעולה, בוא נתחיל!']
            },
            {
                id: 2,
                message: 'שימו לב! לפני שאנחנו מתקדמים, מעדכנים שהאתר מופעל בהתאם [למדיניות הפרטיות](https://lp.baz-f.co.il/privacy-policy), אוקי?',
                buttons: ['בסדר גמור, בוא נתקדם']
            },
            {
                id: 3,
                message: 'הכרות קצרה, מה **הגיל** שלך?',
                buttons: ['20-35', '36-45', '46-60', 'מעל 60']
            },
            {
                id: 4,
                message: 'מה **המטרה שלך**?',
                condition: { field: 'age', value: 'מעל 60' },
                buttons: ['ניתוח תיק פיננסי פנסיוני מלא', 'לבנות תיק השקעות וחסכונות', 'לבנות תוכנית יציאה לפנסיה', 'לדאוג לדורות הבאים', 'משכנתא ופתרונות מימון נוספים']
            },
            {
                id: 5,
                message: 'מה **המטרה שלך**?',
                condition: { field: 'age', value: ['20-35', '36-45', '46-60'] },
                buttons: ['ניתוח תיק פיננסי פנסיוני מלא', 'להגדיל את ההון', 'תכנון כלכלי נכון', 'להשקיע חכם', 'להעלות את רמת החיים', 'משכנתא ופתרונות מימון נוספים']
            },
            {
                id: 6,
                message: 'מה **הסטטוס שלך**?',
                buttons: ['רווק/ה', 'נשוי/ה', 'גרוש/ה', 'אלמן/ה', 'ידוע בציבור'],
                gif: 'https://media.giphy.com/media/l41YmQjOz9qg2Ecow/giphy.gif'
            },
            {
                id: 7,
                message: 'מה **הסטטוס התעסוקתי** שלך?',
                buttons: ['שכיר/ה', 'עצמאי/ת', 'שכיר/ה ועצמאי/ת', 'לא עובד/ת', 'בפנסיה', 'בפנסיה ועדיין עובד/ת']
            },
            {
                id: 8,
                message: 'האם יש **הפרשה לביטוח פנסיוני** (פנסיה/מנהלים/גמל)?',
                condition: { field: 'employment', value: ['שכיר/ה', 'עצמאי/ת', 'שכיר/ה ועצמאי/ת'] },
                buttons: ['כן', 'לא', 'לא ידוע לי']
            },
            {
                id: 9,
                message: 'האם קיימים **כספים פנסיוניים** (פנסיה/מנהלים/גמל)?',
                condition: { field: 'employment', value: ['לא עובד/ת', 'בפנסיה', 'בפנסיה ועדיין עובד/ת'] },
                buttons: ['כן', 'לא', 'אין לי מושג']
            },
            {
                id: 10,
                message: 'מה **גובה השכר ברוטו**?\nאם אין שכר כרגע, נא לרשום 0',
                inputType: 'number',
                gif: 'https://media.giphy.com/media/67ThRZlYBvibtdF9JH/giphy.gif',
                placeholder: 'נא לרשום בספרות את גובה השכר שלך'
            },
            {
                id: 11,
                message: 'מה **גובה ההון הפנסיוני** שברשותך?\n(פנסיה, מנהלים וקופות גמל בלבד)',
                buttons: ['עד 100,000 ₪', 'עד 500,000 ₪', 'מעל 750,000 ₪', 'לא ידוע לי']
            },
            {
                id: 12,
                message: 'מה **גובה ההון** שברשותך?\n(ללא פנסיה, רק השתלמות, עו"ש חסכונות והשקעות)',
                buttons: ['עד 300,000', 'עד 500,000', 'עד 750,000', 'מיליון שח וצפונה']
            },
            {
                id: 13,
                message: 'האם קיימים **השקעות וחסכונות**?',
                buttons: ['בבנק', 'בבית השקעות', 'מנהל השקעות', 'באופן פרטי', 'כל מיני סוגים', 'כרגע לא'],
                gif: 'https://media.giphy.com/media/LdOyjZ7io5Msw/giphy.gif'
            },
            {
                id: 14,
                message: 'האם ידוע לך כמה **תשואה** סה"כ הנכסים הפיננסיים שלך עשו בשנה האחרונה?',
                buttons: ['כן', 'לא']
            },
            {
                id: 15,
                message: 'מהי **התשואה**?',
                condition: { field: 'knowsReturn', value: 'כן' },
                buttons: ['א. עד 5%', 'ב. עד 10%', 'ג. יותר מ 10%', 'ד. לא ידוע לי']
            },
            {
                id: 16,
                message: 'באיזה **מסלולי השקעה** הקופות הפנסיוניות שלך?',
                condition: { field: 'knowsReturn', value: 'לא' },
                buttons: ['א. מסלולים סולידיים', 'ב. מסלולים אגרסיביים', 'ג. מסלולים מעורבים', 'ד. אין לי מושג']
            },
            {
                id: 17,
                message: 'שאלה אחרונה, האם קיימת **משכנתא**?',
                buttons: ['כן', 'לא', 'יש תכנון לקחת בקרוב'],
                gif: 'https://media.giphy.com/media/3o6Zt11R527fgtrIJO/giphy.gif'
            },
            {
                id: 18,
                message: 'תודה רבה על הזמן שהקדשת למילוי השאלון.\nאשמח לדעת מה **שמך**, שאוכל להמשיך בתהליך.',
                inputType: 'text'
            },
            {
                id: 19,
                message: 'תודה על מילוי הפרטים אשמח שנקבע שיחה או זום של רבע שעה כדי שנראה שניתן לצאת לדרך יחד',
                gif: 'https://media.giphy.com/media/3o6Zt6KHxJTbXCnSvu/giphy.gif',
                buttons: ['לקביעת פגישה']
            }
        ];

        function MessageBubble({ message, isBot, gif, onGifLoad, buttons, onButtonClick, inputType, onInputSubmit, placeholder, inputValidation }) {
            const [inputValue, setInputValue] = useState('');
            const [selectedButton, setSelectedButton] = useState(null);
            const [imageLoaded, setImageLoaded] = useState(false);

            const handleButtonClick = (button) => {
                setSelectedButton(button);
                onButtonClick?.(button);
            };

            const getButtonClass = (button) => {
                if (message.includes('מה **המטרה שלך**') && button === 'ניתוח תיק פיננסי פנסיוני מלא') {
                    return 'chat-button special';
                }
                return 'chat-button';
            };

            const handleImageLoad = () => {
                setImageLoaded(true);
                onGifLoad?.();
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                if (inputValue && (!inputValidation || inputValidation(inputValue))) {
                    onInputSubmit?.(inputValue);
                    setInputValue('');
                }
            };

            const isImageUrl = gif?.startsWith('http');

            return (
                <div className="message-wrapper">
                    <div className={`message-container ${isBot ? 'bot' : 'user'}`}>
                        <div className={`message-bubble ${isBot ? 'bot' : 'user'}`}>
                            <div className="message-text">
                                {message.split(/(\*\*.*?\*\*|\[.*?\]\(.*?\))/).map((part, index) => {
                                    if (part.startsWith('**') && part.endsWith('**')) {
                                        return <strong key={index}>{part.slice(2, -2)}</strong>;
                                    }
                                    // Parse markdown-style links [text](url)
                                    const linkMatch = part.match(/^\[(.*?)\]\((.*?)\)$/);
                                    if (linkMatch) {
                                        return <a key={index} href={linkMatch[2]} target="_blank" rel="noopener noreferrer" style={{ color: '#28c76f', textDecoration: 'underline' }}>{linkMatch[1]}</a>;
                                    }
                                    return <span key={index}>{part}</span>;
                                })}
                            </div>
                            {gif && (
                                <div className="message-image">
                                    <div style={{ opacity: imageLoaded ? 1 : 0, transition: 'opacity 0.3s' }}>
                                        <img
                                            src={gif}
                                            alt="Chat media"
                                            onLoad={handleImageLoad}
                                            style={{ maxWidth: '800px', width: '100%', height: 'auto' }}
                                        />
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    {isBot && buttons && buttons.length > 0 && (
                        <div className="message-buttons">
                            {buttons.map((button, index) => (
                                <button
                                    key={index}
                                    onClick={() => handleButtonClick(button)}
                                    className={getButtonClass(button)}
                                    disabled={selectedButton !== null}
                                >
                                    {button}
                                </button>
                            ))}
                        </div>
                    )}
                    {isBot && inputType && (
                        <form onSubmit={handleSubmit} className="message-input-form">
                            <div className="input-group">
                                <input
                                    type={inputType}
                                    value={inputValue}
                                    onChange={(e) => setInputValue(e.target.value)}
                                    placeholder={placeholder}
                                    className="chat-input"
                                />
                                <button type="submit" className="submit-button">
                                    שלח
                                </button>
                            </div>
                        </form>
                    )}
                </div>
            );
        }

        function ChatBot() {
            const [messages, setMessages] = useState([]);
            const [currentStep, setCurrentStep] = useState(chatSteps[0]);
            const [userAnswers, setUserAnswers] = useState({});
            const [utmParams, setUtmParams] = useState({});
            const [sessionId, setSessionId] = useState(null);
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                setTimeout(() => {
                    messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' });
                }, 100);
            };

            const generateNewSessionId = () => {
                // Generate a random session ID to avoid Make.com remembering the old session
                const timestamp = Date.now();
                const random = Math.random().toString(36).substring(2, 15);
                return `reset_${timestamp}_${random}`;
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const captured = {};
                const utmSource = params.get('utm_source');
                const utmCampaign = params.get('utm_campaign');
                const utmContent = params.get('utm_content');
                const session = params.get('session');

                if (utmSource) captured.utm_source = utmSource;
                if (utmCampaign) captured.utm_campaign = utmCampaign;
                if (utmContent) captured.utm_content = utmContent;

                setUtmParams(captured);
                console.log('Captured UTM parameters:', captured);

                if (session) {
                    setSessionId(session);
                    console.log('Captured session ID:', session);
                } else {
                    console.warn('No session ID in URL - WhatsApp bot may not identify sender correctly');
                }
            }, []);

            useEffect(() => {
                if (messages.length === 0) {
                    setMessages([{
                        message: currentStep.message,
                        isBot: true,
                        gif: currentStep.gif,
                        buttons: currentStep.buttons,
                        inputType: currentStep.inputType,
                        placeholder: currentStep.placeholder || getPlaceholder(currentStep.inputType),
                        inputValidation: currentStep.validation
                    }]);
                }
            }, [messages.length, currentStep]);

            const sendToWebhook = async (data) => {
                const payload = {
                    ...data,
                    ...utmParams,
                    ...(sessionId && { session_id: sessionId })
                };
                try {
                    const response = await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (response.ok) {
                        console.log('Successfully sent to webhook:', payload);
                        if (window.fbq) {
                            window.fbq('track', 'ChatbotComplete');
                        }
                    } else {
                        console.error('Failed to send to webhook:', result);
                        // Show error message to user
                        if (result.message) {
                            alert(result.message);
                        }
                    }
                } catch (error) {
                    console.error('Error sending to webhook:', error);
                    alert('מצטער/ת, משהו השתבש. אנא נסה/י שוב.');
                }
            };

            const handleUserInput = (input) => {
                console.log('Handling user input:', input);

                // Check for appointment booking button
                if (input === 'לקביעת פגישה') {
                    console.log('Appointment booking button clicked - redirecting to lp.baz-f.co.il');
                    window.open('https://lp.baz-f.co.il', '_blank');
                    return;
                }

                // Check for reset keyword
                if (input && input.toString().toLowerCase().trim() === 'reset') {
                    console.log('Reset keyword detected - restarting chatbot');

                    // Notify Make.com about the reset
                    if (sessionId) {
                        sendToWebhook({
                            action: 'reset',
                            old_session_id: sessionId,
                            message: 'User requested reset'
                        });
                    }

                    const newSessionId = generateNewSessionId();
                    console.log('Generated new session ID:', newSessionId);
                    setSessionId(newSessionId);
                    setMessages([]);
                    setUserAnswers({});
                    setCurrentStep(chatSteps[0]);
                    return;
                }

                // Check for "התחל מחדש" button
                if (input === 'התחל מחדש') {
                    console.log('Restart button clicked - restarting chatbot');

                    // Notify Make.com about the reset
                    if (sessionId) {
                        sendToWebhook({
                            action: 'reset',
                            old_session_id: sessionId,
                            message: 'User clicked restart button'
                        });
                    }

                    const newSessionId = generateNewSessionId();
                    console.log('Generated new session ID:', newSessionId);
                    setSessionId(newSessionId);
                    setMessages([]);
                    setUserAnswers({});
                    setCurrentStep(chatSteps[0]);
                    return;
                }

                if (currentStep.inputType) {
                    setMessages(prev => [...prev, { message: input, isBot: false }]);
                }

                const fieldName = getFieldName(currentStep);
                const newAnswers = { ...userAnswers, [fieldName]: input };
                setUserAnswers(newAnswers);
                console.log('Updated user answers:', newAnswers);

                if (currentStep.id === 18) {
                    console.log('Name filled, sending webhook with all form data');
                    setTimeout(() => sendToWebhook(newAnswers), 100);
                }

                const nextStep = findNextStep(currentStep.id, input, newAnswers);
                if (nextStep) {
                    setCurrentStep(nextStep);
                    setMessages(prev => [...prev, {
                        message: nextStep.message,
                        isBot: true,
                        gif: nextStep.gif,
                        buttons: nextStep.buttons,
                        inputType: nextStep.inputType,
                        placeholder: nextStep.placeholder,
                        inputValidation: nextStep.validation
                    }]);
                }
            };

            const getPlaceholder = (inputType) => {
                switch (inputType) {
                    case 'number': return 'נא לרשום בספרות את גובה השכר שלך';
                    case 'tel': return 'מספר טלפון נייד';
                    case 'email': return 'כתובת אימייל';
                    default: return '';
                }
            };

            const findNextStep = (currentId, input, answers) => {
                const immediateNext = chatSteps.find(step => {
                    if (step.id !== currentId + 1) return false;
                    if (!step.condition) return true;

                    const { field, value } = step.condition;
                    const answer = answers[field];

                    if (field === 'age') {
                        if (value === 'מעל 60' && answer === 'מעל 60') return true;
                        if (Array.isArray(value) && value.includes(answer)) return true;
                        return false;
                    }

                    return Array.isArray(value) ? value.includes(answer) : answer === value;
                });

                if (immediateNext) return immediateNext;

                for (let id = currentId + 2; id <= chatSteps.length; id++) {
                    const step = chatSteps.find(s => s.id === id);
                    if (!step) continue;
                    if (!step.condition) return step;

                    const { field, value } = step.condition;
                    const answer = answers[field];

                    if (field === 'age') {
                        if (value === 'מעל 60' && answer === 'מעל 60') return step;
                        if (Array.isArray(value) && value.includes(answer)) return step;
                        continue;
                    }

                    if (Array.isArray(value) ? value.includes(answer) : answer === value) {
                        return step;
                    }
                }

                return null;
            };

            const getFieldName = (step) => {
                const fieldMap = {
                    2: 'privacyConsent',
                    3: 'age',
                    4: 'goal',
                    5: 'goal',
                    6: 'status',
                    7: 'employment',
                    8: 'pension',
                    9: 'pension',
                    10: 'salary',
                    11: 'pensionAmount',
                    12: 'savings',
                    13: 'investments',
                    14: 'knowsReturn',
                    15: 'return',
                    16: 'investmentType',
                    17: 'mortgage',
                    18: 'name',
                    19: 'thankYouAck'
                };
                return fieldMap[step.id] || `step${step.id}`;
            };

            return (
                <div className="chat-container">
                    <a href="/" className="back-button">חזרה לאתר</a>
                    <div className="chat-messages">
                        <div className="messages-inner">
                            {messages.map((msg, index) => (
                                <MessageBubble
                                    key={index}
                                    message={msg.message}
                                    isBot={msg.isBot}
                                    gif={msg.gif}
                                    onGifLoad={scrollToBottom}
                                    buttons={msg.buttons}
                                    onButtonClick={handleUserInput}
                                    inputType={msg.inputType}
                                    onInputSubmit={handleUserInput}
                                    placeholder={msg.placeholder}
                                    inputValidation={msg.inputValidation}
                                />
                            ))}
                            <div ref={messagesEndRef} />
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ChatBot />);
    </script>
</body>
</html>
